<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√¨m gi√° tr·ªã c·ªßa m·ªôt s·ªë - EduRobot</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --primary: #9b59b6;
            --success: #27ae60;
            --error: #e74c3c;
            --bg: #fdfafb;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg);
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 2px solid #f1f1f1;
        }

        h1 {
            text-align: center;
            color: #8e44ad;
            margin-bottom: 10px;
        }

        .desc {
            text-align: center;
            margin-bottom: 30px;
            font-style: italic;
            color: #7f8c8d;
        }

        .quiz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .question-item {
            border: 2px solid #f3f4f6;
            padding: 20px;
            border-radius: 12px;
            background: #fff;
            transition: 0.3s;
        }

        .question-item:hover {
            border-color: var(--primary);
        }

        .input-group {
            display: flex;
            align-items: center;
            margin-top: 15px;
            gap: 8px;
        }

        input[type="text"] {
            width: 90px;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            outline: none;
        }

        .check-btn {
            padding: 10px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .status-icon {
            font-size: 28px;
            min-width: 35px;
            text-align: center;
        }

        .correct-bg {
            background-color: #eafaf1 !important;
            border-color: var(--success) !important;
        }

        .wrong-bg {
            background-color: #fdf2f2 !important;
            border-color: var(--error) !important;
        }

        #summary-section {
            margin-top: 40px;
            text-align: center;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .btn-finish {
            background: var(--success);
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 50px;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>B√ÄI T·∫¨P: T√åM GI√Å TR·ªä C·ª¶A M·ªòT S·ªê</h1>
        <p class="desc">T√≠nh gi√° tr·ªã ph·∫ßn trƒÉm c·ªßa c√°c s·ªë d∆∞·ªõi ƒë√¢y. Ch·∫•p nh·∫≠n c√°c d·∫°ng vi·∫øt nh∆∞ 10 ho·∫∑c 10,0.</p>

        <div id="quiz-container" class="quiz-grid"></div>

        <div id="summary-section">
            <button class="btn-finish" onclick="checkAll()">N·ªôp t·∫•t c·∫£ b√†i l√†m</button>
            <button class="btn-finish" style="background: #3498db; margin-left: 10px;"
                onclick="downloadLessonScore()">T·∫£i B·∫£ng ƒêi·ªÉm B√†i N√†y</button>
            <div id="final-score" style="margin-top: 20px; font-size: 24px; font-weight: bold;"></div>
        </div>
    </div>

    <audio id="sound-correct" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>
    <audio id="sound-wrong" src="https://assets.mixkit.co/active_storage/sfx/253/253-preview.mp3"></audio>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        // Firebase Config
        const firebaseConfig = { databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let startTime = Date.now();
        const quizData = [
            { p: 15, total: 80, ans: 12 }, { p: 20, total: 150, ans: 30 }, { p: 25, total: 40, ans: 10 },
            { p: 10, total: 95, ans: 9.5 }, { p: 5, total: 120, ans: 6 }, { p: 30, total: 60, ans: 18 },
            { p: 12, total: 50, ans: 6 }, { p: 75, total: 200, ans: 150 }, { p: 40, total: 25, ans: 10 },
            { p: 8, total: 125, ans: 10 }, { p: 35, total: 200, ans: 70 }, { p: 0.5, total: 400, ans: 2 },
            { p: 12.5, total: 80, ans: 10 }, { p: 60, total: 45, ans: 27 }, { p: 18, total: 150, ans: 27 },
            { p: 2, total: 500, ans: 10 }, { p: 45, total: 80, ans: 36 }, { p: 150, total: 60, ans: 90 },
            { p: 2.5, total: 200, ans: 5 }, { p: 70, total: 30, ans: 21 }
        ];

        // Randomize question order
        quizData.sort(() => Math.random() - 0.5);

        const container = document.getElementById('quiz-container');

        quizData.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'question-item';
            div.id = `q-item-${index}`;
            div.innerHTML = `
            <div><b>C√¢u ${index + 1}:</b> T√¨m <b>${item.p}%</b> c·ªßa <b>${item.total}</b></div>
            <div class="input-group">
                <input type="text" id="input-${index}" placeholder="..." autocomplete="off">
                <button class="check-btn" onclick="checkSingle(${index})">Ki·ªÉm tra</button>
                <span id="icon-${index}" class="status-icon"></span>
            </div>
        `;
            container.appendChild(div);
        });

        function checkSingle(index) {
            let userVal = document.getElementById(`input-${index}`).value.trim().replace(',', '.');
            let userNum = parseFloat(userVal);
            const correctVal = quizData[index].ans;
            const itemDiv = document.getElementById(`q-item-${index}`);
            const iconSpan = document.getElementById(`icon-${index}`);

            if (!isNaN(userNum) && Math.abs(userNum - correctVal) < 0.01) {
                itemDiv.classList.replace('wrong-bg', 'correct-bg') || itemDiv.classList.add('correct-bg');
                iconSpan.innerHTML = '‚úÖ';
                playSuperSuccess();
                return true;
            } else {
                itemDiv.classList.replace('correct-bg', 'wrong-bg') || itemDiv.classList.add('wrong-bg');
                iconSpan.innerHTML = 'üòü';
                document.getElementById('sound-wrong').play();
                return false;
            }
        }

        function playSuperSuccess() {
            // Ph√°t √¢m thanh v·ªó tay
            const snd = document.getElementById('sound-correct');
            snd.currentTime = 0;
            snd.play();

            // Ph√°o gi·∫•y m·∫≠t ƒë·ªô cao (500 h·∫°t)
            confetti({
                particleCount: 500,
                spread: 120,
                origin: { y: 0.6 },
                scalar: 1.2,
                colors: ['#8e44ad', '#2ecc71', '#3498db', '#f1c40f', '#ff69b4']
            });
        }

        function checkAll() {
            let count = 0;
            quizData.forEach((_, i) => { if (checkSingle(i)) count++; });
            document.getElementById('final-score').innerText = `K·∫øt qu·∫£ cu·ªëi c√πng: ${count}/${quizData.length} c√¢u ƒë√∫ng!`;

            if (count === quizData.length) {
                // Hi·ªáu ·ª©ng ph√°o hoa k√©o d√†i 3 gi√¢y n·∫øu ƒë√∫ng h·∫øt
                let end = Date.now() + 3000;
                (function frame() {
                    confetti({ particleCount: 30, angle: 60, spread: 80, origin: { x: 0 }, colors: ['#ff0000', '#ffd700'] });
                    confetti({ particleCount: 30, angle: 120, spread: 80, origin: { x: 1 }, colors: ['#0000ff', '#ffffff'] });
                    if (Date.now() < end) requestAnimationFrame(frame);
                }());
            }
            saveScore(count);
        }

        function saveScore(score) {
            const fullName = localStorage.getItem('studentName') || "Ch∆∞a nh·∫≠p t√™n";
            const className = localStorage.getItem('studentClass') || "Ch∆∞a nh·∫≠p l·ªõp";
            const duration = Math.floor((Date.now() - startTime) / 1000); // seconds

            const data = {
                fullName: fullName,
                className: className,
                score: score,
                total: quizData.length,
                duration: duration,
                date: new Date().toISOString()
            };

            db.ref('scores/Giatriphantram').push(data)
                .then(() => {
                    console.log("L∆∞u ƒëi·ªÉm th√†nh c√¥ng!");
                    // alert("ƒê√£ l∆∞u ƒëi·ªÉm th√†nh c√¥ng l√™n h·ªá th·ªëng!"); // Optional: Notify user
                })
                .catch((error) => {
                    console.error("L·ªói khi l∆∞u ƒëi·ªÉm:", error);
                });
        }

        function downloadLessonScore() {
            const btn = document.querySelector('button[onclick="downloadLessonScore()"]');
            btn.innerText = "‚è≥ ƒêang t·∫£i...";
            btn.disabled = true;

            db.ref('scores/Giatriphantram').once('value').then(snapshot => {
                const data = snapshot.val();
                if (!data) {
                    alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm n√†o cho b√†i n√†y!");
                    btn.innerText = "T·∫£i B·∫£ng ƒêi·ªÉm B√†i N√†y";
                    btn.disabled = false;
                    return;
                }

                const rows = [];
                let serialNumber = 1;

                // data is object { pushKey: { ...entry } }
                const entries = Object.values(data);

                // Sort by name then date
                entries.sort((a, b) => {
                    if (a.fullName === b.fullName) {
                        return new Date(a.date) - new Date(b.date);
                    }
                    return a.fullName.localeCompare(b.fullName);
                });

                const attemptMap = {};

                entries.forEach(entry => {
                    const studentKey = entry.fullName + "_" + entry.className;
                    if (!attemptMap[studentKey]) requestAnimationFrame = 0; // Fix potential reference error if copy paste
                    if (!attemptMap[studentKey]) attemptMap[studentKey] = 0;
                    attemptMap[studentKey]++;

                    rows.push({
                        "TT": serialNumber++,
                        "T√™n": entry.fullName,
                        "L·ªõp": entry.className,
                        "ƒêi·ªÉm": entry.score,
                        "l·∫ßn l√†m": attemptMap[studentKey]
                    });
                });

                const worksheet = XLSX.utils.json_to_sheet(rows);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Diem_Giatriphantram");

                const max_width = rows.reduce((w, r) => Math.max(w, (r["T√™n"] || "").length), 10);
                worksheet['!cols'] = [
                    { wch: 5 }, { wch: max_width + 5 }, { wch: 10 }, { wch: 10 }, { wch: 10 }
                ];

                XLSX.writeFile(workbook, "Diem_Giatriphantram.xlsx");

                btn.innerText = "T·∫£i B·∫£ng ƒêi·ªÉm B√†i N√†y";
                btn.disabled = false;
            }).catch(error => {
                console.error(error);
                alert("L·ªói: " + error.message);
                btn.innerText = "T·∫£i B·∫£ng ƒêi·ªÉm B√†i N√†y";
                btn.disabled = false;
            });
        }
    </script>
</body>

</html>