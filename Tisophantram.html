<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·ªâ s·ªë ph·∫ßn trƒÉm a/b - EduRobot</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --success: #27ae60;
            --error: #e74c3c;
            --bg: #f4f7f6;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg);
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2980b9;
            margin-bottom: 10px;
        }

        .desc {
            text-align: center;
            margin-bottom: 30px;
            font-style: italic;
            color: #7f8c8d;
        }

        .quiz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .question-item {
            border: 2px solid #ecf0f1;
            padding: 20px;
            border-radius: 12px;
            background: #fff;
            transition: 0.3s;
        }

        .question-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .input-group {
            display: flex;
            align-items: center;
            margin-top: 15px;
            gap: 8px;
        }

        input[type="text"] {
            width: 80px;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            outline: none;
        }

        .check-btn {
            padding: 10px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .status-icon {
            font-size: 28px;
            min-width: 35px;
            text-align: center;
        }

        .correct-bg {
            background-color: #e8f6ed !important;
            border-color: var(--success) !important;
        }

        .wrong-bg {
            background-color: #fdedee !important;
            border-color: var(--error) !important;
        }

        #summary-section {
            margin-top: 40px;
            text-align: center;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .btn-finish {
            background: var(--success);
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 50px;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>B√ÄI T·∫¨P: T√åM T·ªà S·ªê PH·∫¶N TRƒÇM</h1>
        <p class="desc">T√≠nh t·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa a so v·ªõi b. Ch·∫•p nh·∫≠n c√°c c√°ch vi·∫øt nh∆∞ 52 ho·∫∑c 52,0.</p>

        <div id="quiz-container" class="quiz-grid"></div>

        <div id="summary-section">
            <button class="btn-finish" onclick="checkAll()">N·ªôp t·∫•t c·∫£ b√†i l√†m</button>
            <button class="btn-finish" style="background: #3498db; margin-left: 10px;"
                onclick="downloadLessonScore()">T·∫£i B·∫£ng ƒêi·ªÉm B√†i N√†y</button>
            <div id="final-score" style="margin-top: 20px; font-size: 24px; font-weight: bold;"></div>
        </div>
    </div>

    <audio id="sound-correct" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>
    <audio id="sound-wrong" src="https://assets.mixkit.co/active_storage/sfx/253/253-preview.mp3"></audio>

    <script>
        const quizData = [
            { a: 13, b: 25, ans: 52.0 }, { a: 7, b: 40, ans: 17.5 }, { a: 9, b: 15, ans: 60.0 },
            { a: 12, b: 16, ans: 75.0 }, { a: 1, b: 8, ans: 12.5 }, { a: 3, b: 5, ans: 60.0 },
            { a: 14, b: 35, ans: 40.0 }, { a: 5, b: 16, ans: 31.3 }, { a: 21, b: 28, ans: 75.0 },
            { a: 2, b: 3, ans: 66.7 }, { a: 17, b: 20, ans: 85.0 }, { a: 11, b: 16, ans: 68.8 },
            { a: 6, b: 15, ans: 40.0 }, { a: 1, b: 3, ans: 33.3 }, { a: 19, b: 40, ans: 47.5 },
            { a: 4, b: 7, ans: 57.1 }, { a: 15, b: 24, ans: 62.5 }, { a: 3, b: 11, ans: 27.3 },
            { a: 8, b: 12, ans: 66.7 }, { a: 25, b: 32, ans: 78.1 }
        ];

        // Randomize
        quizData.sort(() => Math.random() - 0.5);

        const container = document.getElementById('quiz-container');

        quizData.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'question-item';
            div.id = `q-item-${index}`;
            div.innerHTML = `
            <div><b>C√¢u ${index + 1}:</b> T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa <b>${item.a}</b> v√† <b>${item.b}</b></div>
            <div class="input-group">
                <input type="text" id="input-${index}" autocomplete="off"> <b>%</b>
                <button class="check-btn" onclick="checkSingle(${index})">Ki·ªÉm tra</button>
                <span id="icon-${index}" class="status-icon"></span>
            </div>
        `;
            container.appendChild(div);
        });

        function checkSingle(index) {
            let userVal = document.getElementById(`input-${index}`).value.trim().replace(',', '.');
            let userNum = parseFloat(userVal);
            const correctVal = quizData[index].ans;
            const itemDiv = document.getElementById(`q-item-${index}`);
            const iconSpan = document.getElementById(`icon-${index}`);

            if (!isNaN(userNum) && Math.abs(userNum - correctVal) < 0.05) {
                itemDiv.className = 'question-item correct-bg';
                iconSpan.innerHTML = '‚úÖ';
                playSuperSuccess();
                return true;
            } else {
                itemDiv.className = 'question-item wrong-bg';
                iconSpan.innerHTML = 'üòü';
                document.getElementById('sound-wrong').play();
                return false;
            }
        }

        function playSuperSuccess() {
            const snd = document.getElementById('sound-correct');
            snd.currentTime = 0;
            snd.play();
            confetti({
                particleCount: 500,
                spread: 120,
                origin: { y: 0.6 },
                scalar: 1.2,
                colors: ['#3498db', '#2ecc71', '#f1c40f', '#e74c3c']
            });
        }

        let startTime = Date.now();

        function checkAll() {
            let count = 0;
            quizData.forEach((_, i) => { if (checkSingle(i)) count++; });
            document.getElementById('final-score').innerText = `K·∫øt qu·∫£: ${count}/${quizData.length} c√¢u ƒë√∫ng!`;
            if (count === quizData.length) {
                let end = Date.now() + 3000;
                (function frame() {
                    confetti({ particleCount: 30, angle: 60, spread: 80, origin: { x: 0 } });
                    confetti({ particleCount: 30, angle: 120, spread: 80, origin: { x: 1 } });
                    if (Date.now() < end) requestAnimationFrame(frame);
                }());
            }
            saveScore(count);
        }

        function saveScore(score) {
            // Initialize Firebase if not already done (it is done in index.html but this page might be loaded directly, wait no this page doesn't have firebase init code yet! Adding it.)
            if (!firebase.apps.length) {
                const firebaseConfig = { databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app" };
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.database();

            const fullName = localStorage.getItem('studentName') || "Ch∆∞a nh·∫≠p t√™n";
            const className = localStorage.getItem('studentClass') || "Ch∆∞a nh·∫≠p l·ªõp";
            const duration = Math.floor((Date.now() - startTime) / 1000); // seconds

            const data = {
                fullName: fullName,
                className: className,
                score: score,
                total: quizData.length,
                duration: duration,
                date: new Date().toISOString()
            };

            db.ref('scores/Tisophantram').push(data)
                .then(() => {
                    console.log("L∆∞u ƒëi·ªÉm th√†nh c√¥ng!");
                })
                .catch((error) => {
                    console.error("L·ªói khi l∆∞u ƒëi·ªÉm:", error);
                });
        }

        function downloadLessonScore() {
            if (typeof XLSX === 'undefined') {
                alert("L·ªói: Th∆∞ vi·ªán xu·∫•t Excel ch∆∞a t·∫£i xong. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i sau gi√¢y l√°t.");
                return;
            }
            const btn = document.querySelector('button[onclick="downloadLessonScore()"]');
            btn.innerText = "‚è≥ ƒêang t·∫£i...";
            btn.disabled = true;

            const db = firebase.database();
            db.ref('scores/Tisophantram').once('value').then(snapshot => {
                const data = snapshot.val();
                if (!data) {
                    alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm n√†o cho b√†i n√†y!");
                    btn.innerText = "T·∫£i B·∫£ng ƒêi·ªÉm B√†i N√†y";
                    btn.disabled = false;
                    return;
                }

                const rows = [];
                let serialNumber = 1;
                const entries = Object.values(data);

                entries.sort((a, b) => {
                    if (a.fullName === b.fullName) {
                        return new Date(a.date) - new Date(b.date);
                    }
                    return a.fullName.localeCompare(b.fullName);
                });

                const attemptMap = {};

                entries.forEach(entry => {
                    const studentKey = entry.fullName + "_" + entry.className;
                    if (!attemptMap[studentKey]) attemptMap[studentKey] = 0;
                    attemptMap[studentKey]++;

                    rows.push({
                        "TT": serialNumber++,
                        "T√™n": entry.fullName,
                        "L·ªõp": entry.className,
                        "ƒêi·ªÉm": entry.score,
                        "l·∫ßn l√†m": attemptMap[studentKey]
                    });
                });

                const worksheet = XLSX.utils.json_to_sheet(rows);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Diem_Tisophantram");

                const max_width = rows.reduce((w, r) => Math.max(w, (r["T√™n"] || "").length), 10);
                worksheet['!cols'] = [
                    { wch: 5 }, { wch: max_width + 5 }, { wch: 10 }, { wch: 10 }, { wch: 10 }
                ];

                XLSX.writeFile(workbook, "Diem_Tisophantram.xlsx");

                btn.innerText = "T·∫£i B·∫£ng ƒêi·ªÉm B√†i N√†y";
                btn.disabled = false;
            }).catch(error => {
                console.error(error);
                alert("L·ªói: " + error.message);
                btn.innerText = "T·∫£i B·∫£ng ƒêi·ªÉm B√†i N√†y";
                btn.disabled = false;
            });
        }
    </script>
</body>

</html>