<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng B√†i t·∫≠p To√°n - EduRobot</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            --text-color: #2d3436;
            --bg-color: #f0f2f5;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .main-menu {
            text-align: center;
            background: white;
            padding: 50px;
            border-radius: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 90%;
        }

        h1 {
            color: #4834d4;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            color: #636e72;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        .grid-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }

        .card {
            text-decoration: none;
            padding: 30px;
            border-radius: 20px;
            color: white;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .card-1 {
            background: var(--primary-gradient);
        }

        .card-2 {
            background: var(--secondary-gradient);
        }

        .card i {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .card h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .card p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 10px;
        }

        .footer {
            margin-top: 40px;
            font-size: 0.8rem;
            color: #b2bec3;
        }

        .user-info-form {
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .form-group input {
            padding: 15px 25px;
            border-radius: 50px;
            border: 2px solid #e0e0e0;
            font-size: 1rem;
            width: 250px;
            transition: all 0.3s ease;
            outline: none;
            background: #f9f9f9;
        }

        .form-group input:focus {
            border-color: #6c5ce7;
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
            background: white;
        }
    </style>
</head>

<body>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
    </script>

    <div class="main-menu">
        <h1>H·ªåC TO√ÅN C√ôNG EDUROBOT</h1>
        <p class="subtitle">Vui l√≤ng ch·ªçn ch·ªß ƒë·ªÅ b√†i t·∫≠p b·∫°n mu·ªën luy·ªán t·∫≠p h√¥m nay</p>

        <div class="user-info-form">
            <div class="form-group">
                <input type="text" id="studentName" placeholder="Nh·∫≠p h·ªç v√† t√™n c·ªßa b·∫°n" required>
            </div>
            <div class="form-group">
                <input type="text" id="studentClass" placeholder="Nh·∫≠p l·ªõp" required>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const nameInput = document.getElementById('studentName');
                const classInput = document.getElementById('studentClass');

                // Load saved data if available
                if (localStorage.getItem('studentName')) nameInput.value = localStorage.getItem('studentName');
                if (localStorage.getItem('studentClass')) classInput.value = localStorage.getItem('studentClass');

                // Save data on change
                const saveData = () => {
                    localStorage.setItem('studentName', nameInput.value);
                    localStorage.setItem('studentClass', classInput.value);
                };

                nameInput.addEventListener('input', saveData);
                classInput.addEventListener('input', saveData);
            });
        </script>

        <div class="grid-links">
            <a href="Giatriphantram.html" class="card card-1">
                <h2>Ch·ªß ƒë·ªÅ 2</h2>
                <p>T√¨m gi√° tr·ªã c·ªßa m·ªôt s·ªë</p>
                <strong>B·∫Øt ƒë·∫ßu h·ªçc ‚Üí</strong>
            </a>

            <a href="Tisophantram.html" class="card card-2">
                <h2>Ch·ªß ƒë·ªÅ 1</h2>
                <p>T√¨m t·ªâ s·ªë ph·∫ßn trƒÉm a/b</p>
                <strong>B·∫Øt ƒë·∫ßu h·ªçc ‚Üí</strong>
            </a>
        </div>

        <div class="teacher-panel"
            style="margin-top: 40px; text-align: center; padding: 20px; background: #fff; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
            <h3>Khu v·ª±c Gi√°o Vi√™n</h3>
            <button onclick="downloadExcel()"
                style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                üìä T·∫£i B·∫£ng ƒêi·ªÉm (Excel)
            </button>
        </div>

        <script>
            function downloadExcel() {
                const btn = document.querySelector('button[onclick="downloadExcel()"]');
                btn.innerText = "‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...";
                btn.disabled = true;

                db.ref('scores').once('value').then(snapshot => {
                    const data = snapshot.val();
                    if (!data) {
                        alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm n√†o!");
                        btn.innerText = "üìä T·∫£i B·∫£ng ƒêi·ªÉm (Excel)";
                        btn.disabled = false;
                        return;
                    }

                    const rows = [];
                    let serialNumber = 1;

                    // Iterate through each lesson
                    for (const [lessonName, entries] of Object.entries(data)) {
                        // entries is an object with pushKeys as keys
                        const studentEntries = [];

                        // Convert to array and sort by date to calculate attempt number
                        Object.values(entries).forEach(entry => {
                            studentEntries.push(entry);
                        });

                        // Sort by student name, then by date to determine attempt count
                        studentEntries.sort((a, b) => {
                            if (a.fullName === b.fullName) {
                                return new Date(a.date) - new Date(b.date);
                            }
                            return a.fullName.localeCompare(b.fullName);
                        });

                        // Map to track attempt count for each student in this lesson
                        const attemptMap = {};

                        studentEntries.forEach(entry => {
                            const studentKey = entry.fullName + "_" + entry.className;
                            if (!attemptMap[studentKey]) {
                                attemptMap[studentKey] = 0;
                            }
                            attemptMap[studentKey]++;

                            rows.push({
                                "TT": serialNumber++,
                                "B√†i t√™n": lessonName,
                                "T√™n": entry.fullName,
                                "L·ªõp": entry.className,
                                "ƒêi·ªÉm": entry.score,
                                "l·∫ßn l√†m": attemptMap[studentKey]
                            });
                        });
                    }

                    if (rows.length === 0) {
                        alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá.");
                        btn.innerText = "üìä T·∫£i B·∫£ng ƒêi·ªÉm (Excel)";
                        btn.disabled = false;
                        return;
                    }

                    const worksheet = XLSX.utils.json_to_sheet(rows);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "BangDiem");

                    // Auto-width
                    const max_width = rows.reduce((w, r) => Math.max(w, (r["T√™n"] || "").length), 10);
                    const lesson_width = rows.reduce((w, r) => Math.max(w, (r["B√†i t√™n"] || "").length), 15);

                    worksheet['!cols'] = [
                        { wch: 5 },  // TT
                        { wch: lesson_width + 5 }, // B√†i t√™n
                        { wch: max_width + 5 }, // T√™n
                        { wch: 10 }, // L·ªõp
                        { wch: 10 }, // ƒêi·ªÉm
                        { wch: 10 }  // l·∫ßn l√†m
                    ];

                    XLSX.writeFile(workbook, "BangDiem_EduRobot.xlsx");

                    btn.innerText = "üìä T·∫£i B·∫£ng ƒêi·ªÉm (Excel)";
                    btn.disabled = false;
                }).catch(error => {
                    console.error(error);
                    alert("L·ªói khi t·∫£i d·ªØ li·ªáu: " + error.message);
                    btn.innerText = "üìä T·∫£i B·∫£ng ƒêi·ªÉm (Excel)";
                    btn.disabled = false;
                });
            }
        </script>

        <div class="footer">
            &copy; 2024 EduRobot - H·ªá th·ªëng h·ªçc t·∫≠p th√¥ng minh
        </div>
    </div>

</body>

</html>